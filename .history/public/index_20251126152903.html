<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Register</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .gradient-border {
      position: relative;
      background: white;
      border-radius: 16px;
    }

    .gradient-border::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 16px;
      padding: 2px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
    }

    .status-cell {
      position: relative;
      cursor: pointer;
      transition: all .3s cubic-bezier(.4, 0, .2, 1);
    }

    .status-cell:hover {
      transform: translateY(-2px) scale(1.05);
    }

    .animate-in {
      animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all .3s cubic-bezier(.4, 0, .2, 1);
    }

    .btn-gradient:hover {
      box-shadow: 0 20px 25px -5px rgba(102, 126, 234, .4), 0 10px 10px -5px rgba(102, 126, 234, .3);
      transform: translateY(-2px);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .btn-success:hover {
      box-shadow: 0 20px 25px -5px rgba(16, 185, 129, .4), 0 10px 10px -5px rgba(16, 185, 129, .3);
      transform: translateY(-2px);
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #764ba2, #667eea);
    }

    .present-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 6px -1px rgba(16, 185, 129, .3);
    }

    .absent-badge {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 4px 6px -1px rgba(239, 68, 68, .3);
    }

    .holiday-badge {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      box-shadow: 0 4px 6px -1px rgba(139, 92, 246, .3);
    }

    @media (max-width:768px) {
      .status-cell {
        font-size: 10px;
      }
    }

    /* Portal tooltip styles (rendered at document.body) */
    .tooltip-portal {
      position: fixed;
      z-index: 9999;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 11px;
      white-space: nowrap;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, .3), 0 10px 10px -5px rgba(0, 0, 0, .2);
      pointer-events: none;
      transform-origin: center bottom;
      transition: transform .12s ease, opacity .12s ease;
      opacity: 0.98;
    }

    .tooltip-portal .tip-arrow {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -6px;
      width: 0;
      height: 0;
      border-width: 6px;
      border-style: solid;
      border-color: #111827 transparent transparent transparent;
    }

    .tooltip-portal.below .tip-arrow {
      top: -12px;
      bottom: auto;
      border-color: transparent transparent #111827 transparent;
    }

    /* Styles for Date Dialog on Hover */
    .date-dialog-portal {
      position: fixed;
      z-index: 5000;
      /* Below the main tooltip but above everything else */
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 16px;
      padding: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, .2), 0 10px 10px -5px rgba(0, 0, 0, .1);
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      transform-origin: center top;
      transition: transform 0.1s ease, opacity 0.1s ease;
      border: 1px solid rgba(102, 126, 234, 0.3);
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const API_BASE = 'http://109.106.255.78:5300/api';

    function AttendanceRegister() {
      const [students, setStudents] = useState([]);
      const [attendance, setAttendance] = useState({});
      const [holidays, setHolidays] = useState([]);
      const [month, setMonth] = useState(() => {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      });
      const [loading, setLoading] = useState(false);
      const [file, setFile] = useState(null);
      const [search, setSearch] = useState('');
      const [classFilter, setClassFilter] = useState('All');
      const [showDialog, setShowDialog] = useState(false);
      const [dialogType, setDialogType] = useState('');
      const [selDate, setSelDate] = useState('');
      const [holidayForm, setHolidayForm] = useState({ name: '', reason: '' });
      const [studentForm, setStudentForm] = useState({ name: '', rollNumber: '', phone: '', class: '', level: '', rfidNumber: '' });
      const [view, setView] = useState('monthly');
      const [week, setWeek] = useState(0);
      const [editingStudent, setEditingStudent] = useState(null);

      // tooltip portal state (for P/A badge)
      const [tooltip, setTooltip] = useState({ open: false, left: 0, top: 0, placement: 'above', rec: null });
      // New state for date attendance hover dialog
      const [dateHover, setDateHover] = useState({ open: false, left: 0, top: 0, dateKey: '', day: 0 });
      const dateHoverRef = useRef(null);

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

      const toDateKey = (d) => {
        if (!d) return '';
        const dt = d instanceof Date ? d : new Date(d);
        return dt.toLocaleDateString('en-CA');
      };

      const { yr, mon, name, days } = useMemo(() => {
        const [y, m] = month.split('-').map(Number);
        return { yr: y, mon: m, name: monthNames[m - 1], days: new Date(y, m, 0).getDate() };
      }, [month]);

      // Build weeks so each week includes Sundays (end of week)
      const weeks = useMemo(() => {
        const w = [];
        let curr = [];
        for (let d = 1; d <= days; d++) {
          const dt = new Date(yr, mon - 1, d);
          curr.push(d);
          // end week on Sunday
          if (dt.getDay() === 0) {
            w.push([...curr]);
            curr = [];
          }
        }
        if (curr.length > 0) w.push(curr);
        return w;
      }, [yr, mon, days]);

      // displayDays: include ALL days for header and table (Sundays will render as H)
      const displayDays = useMemo(() => {
        if (view === 'weekly' && weeks[week]) return weeks[week];
        return Array.from({ length: days }, (_, i) => i + 1);
      }, [view, week, days, yr, mon, weeks]);

      // workingDays should exclude Sundays and holidays
      const workingDays = useMemo(() => {
        let c = 0;
        const hDates = holidays.map(h => h.date);
        for (let d = 1; d <= days; d++) {
          const dt = new Date(yr, mon - 1, d);
          const ds = toDateKey(dt);
          if (dt.getDay() !== 0 && !hDates.includes(ds)) c++;
        }
        return c;
      }, [days, yr, mon, holidays]);

      const classes = useMemo(() => ['All', ...new Set(students.map(s => s.class))], [students]);

      useEffect(() => { loadData(); }, [month]);

      async function loadData() {
        setLoading(true);
        try {
          const sr = await fetch(`${API_BASE}/students`);
          if (sr.ok) setStudents(await sr.json());

          const start = `${yr}-${String(mon).padStart(2, '0')}-01`;
          const end = `${yr}-${String(mon).padStart(2, '0')}-${String(days).padStart(2, '0')}`;
          const ar = await fetch(`${API_BASE}/attendance/range?start=${start}&end=${end}`);
          if (ar.ok) {
            const res = await ar.json();
            const att = (res.attendance || []).sort((a, b) => new Date(a.date) - new Date(b.date));
            const hol = res.holidays || [];
            const proc = {};
            att.forEach(r => {
              const u = r.userId?.toString() || '';
              if (!u) return;
              const d = toDateKey(r.date);
              if (!d) return;
              // Assuming simplified single record per student per day for simplicity here
              if (!proc[u]) proc[u] = {};
              proc[u][d] = { status: 'P', checkInTime: r.checkInTime, checkOutTime: r.checkOutTime, scanType: r.scanType || 'qr' };
            });
            setAttendance(proc);
            setHolidays(hol);
          }
        } catch (e) {
          notify(`Error: ${e.message}`, 1);
        } finally {
          setLoading(false);
        }
      }

      const upload = async () => {
        if (!file) return notify('Select file', 1);
        const fd = new FormData(); fd.append('studentFile', file);
        try {
          setLoading(true);
          const r = await fetch(`${API_BASE}/import-students`, { method: 'POST', body: fd });
          if (r.ok) {
            const d = await r.json();
            notify(`${d.count} students imported`);
            setFile(null); setShowDialog(false); loadData();
          } else notify('Upload failed', 1);
        } catch (e) { notify(`Error: ${e.message}`, 1); } finally { setLoading(false); }
      };

      const downloadSample = () => {
        const csv = 'S.N,Name,Roll number,Mobile,Class,Level,RFID,Qr link\n1,Rahul Kumar,R2024001,9876543210,IIT JEE 2026,12,RFID001,https://example.com/qr?data=%7B%22roll_number%22%3A%22R2024001%22%7D';
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'student_sample.csv'; a.click();
        URL.revokeObjectURL(url); notify('Sample downloaded');
      };

      const addStudent = async () => {
        if (!studentForm.name.trim() || !studentForm.rollNumber.trim()) return notify('Enter name and roll number', 1);
        try {
          const r = await fetch(`${API_BASE}/students`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(studentForm) });
          if (r.ok) { notify('Student added'); loadData(); setShowDialog(false); setStudentForm({ name: '', rollNumber: '', phone: '', class: '', level: '', rfidNumber: '' }); }
        } catch (e) { notify(`Error: ${e.message}`, 1); }
      };

      const updateStudent = async () => {
        if (!editingStudent.name.trim() || !editingStudent.rollNumber.trim()) return notify('Enter name and roll number', 1);
        try {
          // Assuming an API endpoint for updating student by ID
          const r = await fetch(`${API_BASE}/students/${editingStudent.userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(editingStudent)
          });
          if (r.ok) { notify('Student updated'); loadData(); setShowDialog(false); setEditingStudent(null); }
        } catch (e) { notify(`Error: ${e.message}`, 1); }
      };

      const addHoliday = async () => {
        if (!holidayForm.name.trim()) return notify('Enter holiday name', 1);
        try {
          const r = await fetch(`${API_BASE}/holidays`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date: selDate, name: holidayForm.name, reason: holidayForm.reason }) });
          if (r.ok) { notify('Holiday added'); loadData(); setShowDialog(false); setHolidayForm({ name: '', reason: '' }); }
        } catch (e) { notify(`Error: ${e.message}`, 1); }
      };

      // Export CSV: Sundays will appear in header and be marked 'H' and not counted in working days
      const exportCSV = () => {
        let csv = 'S.No,Name,Roll,Class,Level,RFID,Phone,';
        displayDays.forEach(d => csv += `${d},`);
        csv += 'Present,Absent,Working Days,Percentage\n';

        filtered.forEach((s, i) => {
          const ua = attendance[s.userId] || {};
          csv += `${i + 1},${s.name || ''},${s.rollNumber || ''},${s.class || ''},${s.level || ''},${s.rfidNumber || s.rfidNumber || ''},${s.phone || ''},`;

          let p = 0, w = 0;

          displayDays.forEach(d => {
            const dt = new Date(yr, mon - 1, d);
            const ds = toDateKey(dt);
            const isSunday = dt.getDay() === 0;
            const h = getHol(ds);

            if (isSunday) {
              csv += 'H,';
              return;
            }

            if (!h) {
              w++;
              const has = !!ua[ds];
              csv += `${has ? 'P' : 'A'},`;
              if (has) p++;
            } else {
              csv += 'H,';
            }
          });

          const pct = w > 0 ? ((p / w) * 100).toFixed(1) : '0.0';
          csv += `${p},${w - p},${w},${pct}%\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Attendance_${view === 'weekly' ? `Week${week + 1}_` : ''}${name}_${yr}.csv`;
        a.click();
        URL.revokeObjectURL(url);

        notify('CSV exported');
      };

      const notify = (msg, err = 0) => {
        const snack = document.createElement('div');
        snack.className = `fixed bottom-4 right-4 px-5 py-3 rounded-xl shadow-2xl text-white text-xs font-semibold z-50 animate-in ${err ? 'bg-gradient-to-r from-red-500 to-red-600' : 'bg-gradient-to-r from-green-500 to-green-600'}`;
        snack.textContent = msg; document.body.appendChild(snack); setTimeout(() => snack.remove(), 3000);
      };

      const changeMonth = (dir) => {
        const [y, m] = month.split('-').map(Number);
        const nd = new Date(y, m - 1 + dir, 1);
        setMonth(`${nd.getFullYear()}-${String(nd.getMonth() + 1).padStart(2, '0')}`); setWeek(0);
      };

      const fmt = (iso) => {
        if (!iso) return '--:--';
        const d = new Date(iso);
        const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
        return local.toTimeString().substring(0, 5);
      };

      const getHol = (ds) => holidays.find(h => h.date === ds) || null;

      const filtered = useMemo(() => {
        let f = students;
        if (classFilter !== 'All') f = f.filter(s => s.class === classFilter);
        if (search.trim()) {
          const q = search.toLowerCase();
          f = f.filter(s => (s.name || '').toLowerCase().includes(q) || (s.rollNumber || '').toLowerCase().includes(q) || (s.userId || '').toString().toLowerCase().includes(q));
        }
        return f;
      }, [students, search, classFilter]);

      const openDialog = (type, date = '', student = null) => {
        setDialogType(type);
        setSelDate(date);
        console.log('openDialog called with type:', type, 'date:', date, 'student:', student);
        if (type === 'edit-student' && student) {
          setEditingStudent({
            userId: student.userId,
            name: student.name || '',
            rollNumber: student.rollNumber || '',
            phone: student.phone || '',
            class: student.class || '',
            level: student.level || '', // Include level here
            rfidNumber: student.rfidNumber || student.rfidNumber || ''
          });
        } else {
          setEditingStudent(null);
        }
        setShowDialog(true);
        setDateHover({ open: false, left: 0, top: 0, dateKey: '', day: 0 }); // Close hover dialog
      };

      // tooltip portal helpers
      const showTooltip = (e, rec) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const spaceAbove = rect.top;
        const spaceBelow = window.innerHeight - rect.bottom;
        const placement = (spaceAbove > 80 || spaceAbove > spaceBelow) ? 'above' : 'below';
        const top = placement === 'above' ? rect.top - 10 : rect.bottom + 10;
        setTooltip({ open: true, left: centerX, top, placement, rec });
      };
      const hideTooltip = () => setTooltip({ open: false, left: 0, top: 0, placement: 'above', rec: null });

      const touchShowThenHide = (e, rec) => {
        e.preventDefault();
        showTooltip(e, rec);
        setTimeout(() => hideTooltip(), 2200);
      };

      // Hover Date Attendance Handlers
      const showDateHover = (e, d) => {
        const dt = new Date(yr, mon - 1, d);
        const dsClick = toDateKey(dt);
        const rect = e.currentTarget.getBoundingClientRect();
        setDateHover({
          open: true,
          left: rect.left + rect.width / 2,
          top: rect.bottom + 5,
          dateKey: dsClick,
          day: d
        });
      };

      const hideDateHover = (e) => {
        // Only hide if the mouse leaves the dialog or the header cell
        if (dateHoverRef.current && dateHoverRef.current.contains(e.relatedTarget)) return;
        setDateHover({ open: false, left: 0, top: 0, dateKey: '', day: 0 });
      };

      // Function to process attendance for a date
      const getAttendanceForDate = (dateKey) => {
        const present = [];
        const absent = [];
        filtered.forEach(s => {
          if (attendance[s.userId] && attendance[s.userId][dateKey]) {
            present.push(s);
          } else {
            absent.push(s);
          }
        });
        return { present, absent };
      };

      return (
        <div className="min-h-screen p-3 md:p-8">
          <div className="glass-effect rounded-3xl shadow-2xl p-5 md:p-8 mb-6 animate-in">
            <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 mb-6">
              <div>
                <h1 className="text-2xl md:text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">üìä Attendance Register</h1>
                <p className="text-xs md:text-sm text-gray-600 font-medium">{name} {yr} ‚Ä¢ {filtered.length} students ‚Ä¢ {workingDays} working days</p>
              </div>
              <div className="flex flex-wrap gap-2">
                <button onClick={() => openDialog('student')} className="px-4 py-2.5 text-xs md:text-sm btn-gradient text-white rounded-xl font-semibold shadow-lg">‚ûï Add Student</button>
                <button onClick={() => openDialog('upload')} className="px-4 py-2.5 text-xs md:text-sm bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-blue-500/50 transition">üì§ Upload</button>
                <button onClick={downloadSample} className="px-4 py-2.5 text-xs md:text-sm bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-purple-500/50 transition">üì• Sample</button>
              </div>
            </div>

            <div className="flex items-center justify-between mb-6">
              <button onClick={() => changeMonth(-1)} className="p-3 rounded-xl glass-card hover:bg-white/20 transition">
                <svg className="w-5 h-5 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M15 19l-7-7 7-7" /></svg>
              </button>

              <div className="flex gap-3">
                <button onClick={() => { setView('monthly'); setWeek(0); }} className={`px-5 py-2 text-xs md:text-sm rounded-xl font-bold transition ${view === 'monthly' ? 'btn-gradient text-white shadow-lg' : 'glass-card text-gray-700 hover:bg-white/20'}`}>üìÖ Monthly</button>
                <button onClick={() => setView('weekly')} className={`px-5 py-2 text-xs md:text-sm rounded-xl font-bold transition ${view === 'weekly' ? 'btn-gradient text-white shadow-lg' : 'glass-card text-gray-700 hover:bg-white/20'}`}>üìÜ Weekly</button>
              </div>

              <button onClick={() => changeMonth(1)} className="p-3 rounded-xl glass-card hover:bg-white/20 transition">
                <svg className="w-5 h-5 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 5l7 7-7 7" /></svg>
              </button>
            </div>

            {view === 'weekly' && (
              <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                {weeks.map((w, i) => <button key={i} onClick={() => setWeek(i)} className={`px-4 py-2 text-xs md:text-sm rounded-xl font-bold whitespace-nowrap transition ${week === i ? 'btn-gradient text-white shadow-lg' : 'glass-card text-gray-700 hover:bg-white/20'}`}>Week {i + 1} ({w[0]}‚Äì{w[w.length - 1]})</button>)}
              </div>
            )}

            <div className="flex flex-col md:flex-row gap-3">
              <input type="text" placeholder="üîç Search student..." value={search} onChange={(e) => setSearch(e.target.value)} className="flex-1 px-4 py-3 text-xs md:text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium bg-white/50 focus:bg-white transition" />
              <select value={classFilter} onChange={(e) => setClassFilter(e.target.value)} className="px-4 py-3 text-xs md:text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-bold bg-white/50">
                {classes.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
              <button onClick={exportCSV} className="px-5 py-3 text-xs md:text-sm btn-success text-white rounded-xl font-bold shadow-lg">üì• Export CSV</button>
            </div>
          </div>

          <div className="glass-effect rounded-3xl shadow-2xl overflow-hidden animate-in">
            <div className="overflow-x-auto overflow-y-auto" style={{ maxHeight: 'calc(100vh - 320px)' }}>
              <table className="min-w-full border-collapse text-xs md:text-sm">
                <thead className="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-600 z-20">
                  <tr>
                    <th className="px-2 py-3 md:px-3 md:py-4 text-left text-[10px] md:text-xs font-bold text-white w-10 sticky left-0 bg-gradient-to-r from-purple-600 to-pink-600 z-30">#</th>
                    <th className="px-2 py-3 md:px-3 md:py-4 text-left text-[10px] md:text-xs font-bold text-white min-w-[120px] md:min-w-[160px] sticky left-10 bg-gradient-to-r from-purple-600 to-pink-600 z-30">Student</th>
                    {displayDays.map(d => {
                      const dt = new Date(yr, mon - 1, d);
                      const ds = toDateKey(dt);
                      const hol = getHol(ds);
                      const isSunday = dt.getDay() === 0;
                      const today = ds === toDateKey(new Date());
                      const dn = ['S', 'M', 'T', 'W', 'T', 'F', 'S'][dt.getDay()];
                      const isHoliday = !!hol || isSunday;
                      return (
                        <th key={d}
                          // Event handlers changed to hover
                          onMouseEnter={(e) => showDateHover(e, d)}
                          onMouseLeave={hideDateHover}
                          className={`px-2 py-3 md:px-3 md:py-4 text-center text-[10px] md:text-xs cursor-pointer transition ${today ? 'bg-yellow-400 text-gray-900 font-bold' : isHoliday ? 'bg-purple-400 text-white' : 'text-white hover:bg-white/20'}`}>
                          <div className="font-bold">{d}</div>
                          <div className="text-[9px] opacity-80">{dn}</div>
                          {hol && <div className="text-[8px] font-bold mt-0.5">{hol.name.substring(0, 3)}</div>}
                          {!hol && isSunday && <div className="text-[8px] font-bold mt-0.5">SUN</div>}
                        </th>
                      );
                    })}
                    <th className="px-2 py-3 md:px-3 md:py-4 text-center text-[10px] md:text-xs font-bold text-white bg-green-600">P</th>
                    <th className="px-2 py-3 md:px-3 md:py-4 text-center text-[10px] md:text-xs font-bold text-white bg-red-600">A</th>
                    <th className="px-2 py-3 md:px-3 md:py-4 text-center text-[10px] md:text-xs font-bold text-white bg-blue-600">%</th>
                    <th className="px-2 py-3 md:px-3 md:py-4 text-center text-[10px] md:text-xs font-bold text-white bg-gray-700 min-w-[60px]">Action</th>
                  </tr>
                </thead>
                <tbody className="bg-white">
                  {filtered.map((s, i) => {
                    const ua = attendance[s.userId] || {};
                    let p = 0, w = 0;
                    displayDays.forEach(d => {
                      const dt = new Date(yr, mon - 1, d);
                      const ds = toDateKey(dt);
                      const isSunday = dt.getDay() === 0;
                      const hol = getHol(ds);
                      if (isSunday) return; // Sundays are holidays and not counted
                      if (!hol) {
                        w++;
                        if (!!ua[ds]) p++;
                      }
                    });
                    const pct = w > 0 ? ((p / w) * 100).toFixed(1) : '0';
                    return (
                      <tr key={s.userId} className="border-b border-gray-100 hover:bg-purple-50/50 transition">
                        <td className="px-2 py-3 md:px-3 md:py-4 text-[10px] md:text-xs text-gray-700 font-bold sticky left-0 bg-white z-10">{i + 1}</td>
                        <td className="px-2 py-3 md:px-3 md:py-4 sticky left-10 bg-white z-10">
                          <div className="font-bold text-gray-900 text-[10px] md:text-xs">{s.name}</div>
                          <div className="text-[9px] md:text-[10px] text-gray-500">{s.rollNumber || s.rfidNumber} ‚Ä¢ {s.class} {s.level ? `(${s.level})` : ''}</div>
                        </td>

                        {displayDays.map(d => {
                          const dt = new Date(yr, mon - 1, d);
                          const ds = toDateKey(dt);
                          const hol = getHol(ds);
                          const isSunday = dt.getDay() === 0;
                          const rec = ua[ds];

                          if (isSunday || hol) {
                            return (
                              <td key={d} className="text-center px-1 py-2 md:px-2 md:py-3">
                                <div className="w-7 h-7 md:w-8 md:h-8 mx-auto holiday-badge rounded-lg flex items-center justify-center text-[10px] md:text-xs font-bold text-white">H</div>
                              </td>
                            );
                          }
                          if (!rec) {
                            return (
                              <td key={d} className="text-center px-1 py-2 md:px-2 md:py-3">
                                <div className="w-7 h-7 md:w-8 md:h-8 mx-auto absent-badge rounded-lg flex items-center justify-center text-[10px] md:text-xs font-bold text-white">A</div>
                              </td>
                            );
                          }

                          return (
                            <td key={d} className="text-center px-1 py-2 md:px-2 md:py-3">
                              <div
                                className="status-cell w-7 h-7 md:w-8 md:h-8 mx-auto present-badge rounded-lg flex items-center justify-center text-[10px] md:text-xs font-bold text-white"
                                onMouseEnter={(e) => showTooltip(e, rec)}
                                onMouseLeave={hideTooltip}
                                onTouchStart={(e) => touchShowThenHide(e, rec)}
                              >
                                P
                              </div>
                            </td>
                          );
                        })}

                        <td className="text-center px-2 py-3 md:px-3 md:py-4 text-[10px] md:text-xs font-bold"><span className="px-2 py-1 rounded-lg bg-green-100 text-green-700">{p}</span></td>
                        <td className="text-center px-2 py-3 md:px-3 md:py-4 text-[10px] md:text-xs font-bold"><span className="px-2 py-1 rounded-lg bg-red-100 text-red-700">{w - p}</span></td>
                        <td className="text-center px-2 py-3 md:px-3 md:py-4 text-[10px] md:text-xs font-bold">
                          <span className={`px-3 py-1 rounded-lg font-bold ${pct >= 75 ? 'bg-gradient-to-r from-green-500 to-green-600 text-white' : pct >= 50 ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white' : 'bg-gradient-to-r from-red-500 to-red-600 text-white'}`}>{pct}%</span>
                        </td>
                        {/* Edit Column */}
                        <td className="text-center px-2 py-3 md:px-3 md:py-4">
                          <button
                            onClick={() => openDialog('edit-student', '', s)}
                            className="text-xs bg-purple-100 text-purple-700 font-semibold px-3 py-1 rounded-full hover:bg-purple-200 transition"
                          >
                            Edit
                          </button>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>

          {showDialog && (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in" onClick={() => setShowDialog(false)}>
              <div className="glass-effect rounded-3xl p-6 md:p-8 max-w-md w-full shadow-2xl animate-in max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                {dialogType === 'student' && (
                  <>
                    <h3 className="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-6">‚ûï Add New Student</h3>
                    <div className="space-y-4">
                      <input type="text" placeholder="Name" value={studentForm.name} onChange={(e) => setStudentForm({ ...studentForm, name: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      <input type="text" placeholder="Roll Number" value={studentForm.rollNumber} onChange={(e) => setStudentForm({ ...studentForm, rollNumber: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      <input type="text" placeholder="Phone" value={studentForm.phone} onChange={(e) => setStudentForm({ ...studentForm, phone: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      <input type="text" placeholder="Class" value={studentForm.class} onChange={(e) => setStudentForm({ ...studentForm, class: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      <input type="text" placeholder="Level/Grade" value={studentForm.level} onChange={(e) => setStudentForm({ ...studentForm, level: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      <input type="text" placeholder="RFID (Optional)" value={studentForm.rfidNumber} onChange={(e) => setStudentForm({ ...studentForm, rfidNumber: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button onClick={() => setShowDialog(false)} className="flex-1 px-5 py-3 text-sm bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-bold transition">Cancel</button>
                      <button onClick={addStudent} className="flex-1 px-5 py-3 text-sm btn-gradient text-white rounded-xl font-bold shadow-lg">Add Student</button>
                    </div>
                  </>
                )}

                {dialogType === 'edit-student' && editingStudent && (
                  <>
                    <h3 className="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-6">üìù Edit Student: {editingStudent.name}</h3>
                    <div className="space-y-4">
                      <input type="text" placeholder="Name" value={editingStudent.name} onChange={(e) => setEditingStudent({ ...editingStudent, name: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      <input type="text" placeholder="Roll Number" value={editingStudent.rollNumber} onChange={(e) => setEditingStudent({ ...editingStudent, rollNumber: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      <input type="text" placeholder="Phone" value={editingStudent.phone} onChange={(e) => setEditingStudent({ ...editingStudent, phone: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      <input type="text" placeholder="Class" value={editingStudent.class} onChange={(e) => setEditingStudent({ ...editingStudent, class: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      <input type="text" placeholder="Level/Grade" value={editingStudent.level} onChange={(e) => setEditingStudent({ ...editingStudent, level: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" /> {/* New Level Field */}
                      <input type="text" placeholder="RFID (Optional)" value={editingStudent.rfidNumber} onChange={(e) => setEditingStudent({ ...editingStudent, rfidNumber: e.target.value })} className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button onClick={() => setShowDialog(false)} className="flex-1 px-5 py-3 text-sm bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-bold transition">Cancel</button>
                      <button onClick={updateStudent} className="flex-1 px-5 py-3 text-sm btn-gradient text-white rounded-xl font-bold shadow-lg">Save Changes</button>
                    </div>
                  </>
                )}

                {dialogType === 'upload' && (
                  <>
                    <h3 className="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-6">üì§ Upload Students</h3>
                    <div className="border-2 border-dashed border-purple-300 rounded-2xl p-8 text-center hover:border-purple-500 transition bg-purple-50/30 mb-4 cursor-pointer">
                      <input type="file" accept=".xlsx,.xls,.csv" onChange={(e) => setFile(e.target.files[0])} className="hidden" id="file-upload" />
                      <label htmlFor="file-upload" className="cursor-pointer">
                        <div className="text-5xl mb-3">üìÑ</div>
                        <div className="text-sm font-bold text-gray-800">{file ? file.name : 'Click to select file'}</div>
                        <div className="text-xs text-gray-500 mt-2">Excel or CSV format</div>
                      </label>
                    </div>
                    <div className="flex gap-3">
                      <button onClick={() => setShowDialog(false)} className="flex-1 px-5 py-3 text-sm bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-bold transition">Cancel</button>
                      <button onClick={upload} disabled={!file || loading} className="flex-1 px-5 py-3 text-sm btn-gradient text-white rounded-xl disabled:opacity-50 font-bold shadow-lg">{loading ? '‚è≥ Uploading...' : 'üì§ Upload'}</button>
                    </div>
                  </>
                )}
                {dialogType === 'holiday' && (
                  <>
                    <h3 className="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-6">üéâ Add Holiday</h3>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-xs font-bold text-gray-700 mb-2">Date</label>
                        <input type="text" value={selDate} readOnly className="w-full px-4 py-3 text-sm bg-purple-50 border-2 border-purple-200 rounded-xl font-bold text-gray-800" />
                      </div>
                      <div>
                        <label className="block text-xs font-bold text-gray-700 mb-2">Holiday Name</label>
                        <input type="text" value={holidayForm.name} onChange={(e) => setHolidayForm({ ...holidayForm, name: e.target.value })} placeholder="e.g., Republic Day" className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none font-medium transition" />
                      </div>
                      <div>
                        <label className="block text-xs font-bold text-gray-700 mb-2">Reason (Optional)</label>
                        <textarea value={holidayForm.reason} onChange={(e) => setHolidayForm({ ...holidayForm, reason: e.target.value })} placeholder="Reason for holiday..." className="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-xl focus:border-purple-500 outline-none resize-none font-medium transition" rows={3}></textarea>
                      </div>
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button onClick={() => setShowDialog(false)} className="flex-1 px-5 py-3 text-sm bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-bold transition">Cancel</button>
                      <button onClick={addHoliday} className="flex-1 px-5 py-3 text-sm btn-gradient text-white rounded-xl font-bold shadow-lg">Add Holiday</button>
                    </div>
                  </>
                )}

                {/* Removed DateAttendanceDialog from here, now using a portal */}
              </div>
            </div>
          )}

          {/* Portal tooltip (P/A badge hover) */}
          {tooltip.open && ReactDOM.createPortal(
            <div
              className={`tooltip-portal ${tooltip.placement === 'below' ? 'below' : ''}`}
              style={{
                left: tooltip.left,
                top: tooltip.top,
                transform: tooltip.placement === 'above' ? 'translate(-50%, -100%)' : 'translate(-50%, 0)'
              }}
            >
              <div className="font-semibold mb-1">‚è∞ Timing</div>
              <div className="flex items-center gap-2 mb-1">
                <span className="text-green-400">‚Üí</span>
                <span>Check In: {fmt(tooltip.rec?.checkInTime)}</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="text-red-400">‚Üê</span>
                <span>Check Out: {fmt(tooltip.rec?.checkOutTime)}</span>
              </div>
              <div className="tip-arrow"></div>
            </div>,
            document.body
          )}

          {/* Portal for Date Attendance Dialog on Header Hover */}
          {dateHover.open && ReactDOM.createPortal(
            <div
              ref={dateHoverRef}
              onMouseLeave={hideDateHover}
              className="date-dialog-portal"
              style={{
                left: dateHover.left,
                top: dateHover.top,
                transform: 'translate(-50%, 0)'
              }}
            >
              <DateAttendanceContent
                dateKey={dateHover.dateKey}
                yr={yr}
                mon={mon}
                holidays={holidays}
                getHol={getHol}
                getAttendanceForDate={getAttendanceForDate}
                openHolidayDialog={() => openDialog('holiday', dateHover.dateKey)} // Pass the date to the holiday dialog
              />
            </div>,
            document.body
          )}
        </div>
      );
    }

    // New Component for Date Attendance Content (for portal)
    function DateAttendanceContent({ dateKey, yr, mon, holidays, getHol, getAttendanceForDate, openHolidayDialog }) {
      const { present, absent } = useMemo(() => getAttendanceForDate(dateKey), [dateKey, getAttendanceForDate]);
      const hol = getHol(dateKey);

      const dateObj = new Date(dateKey);
      const isSunday = dateObj.getDay() === 0;

      return (
        <div className="p-1">
          <h4 className="text-md font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3">
            üóìÔ∏è {dateKey}
          </h4>

          {isSunday && (
            <p className="text-xs font-bold text-purple-700 bg-purple-100 p-2 rounded-lg mb-3">
              This is a Sunday (Holiday).
            </p>
          )}

          {/* Holiday Alert */}
          {hol ? (
            <div
              className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-3 rounded-lg text-xs"
              role="alert"
            >
              <p className="font-bold">{hol.name}</p>
              <p className="text-[10px]">
                {hol.reason || "No specific reason provided."}
              </p>
            </div>
          ) : (
            <>
              {!isSunday && (
                <div className="flex gap-2 mb-3">

                  {/* Mark As Holiday */}
                  <button
                    onClick={openHolidayDialog}
                    className="w-full px-3 py-2 text-xs bg-gradient-to-r from-pink-500 to-pink-600 text-white rounded-xl font-bold shadow-lg hover:shadow-pink-500/50 transition"
                  >
                    Mark as Holiday
                  </button>

                  <button
                    onClick={() => setShowAbsentDialog(true)}
                    className="w-full px-3 py-2 text-xs bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-bold shadow-lg hover:shadow-red-500/50 transition"
                  >
                    Mark as Absent
                  </button>


                </div>
              )}
            </>
          )}

          {/* Present / Absent List */}
          <div className="flex gap-3">
            <div className="flex-1 p-2 bg-green-50/70 rounded-lg">
              <h5 className="text-sm font-bold text-green-700 mb-1">
                ‚úÖ Present ({present.length})
              </h5>
              <div className="max-h-24 overflow-y-auto space-y-1">
                {present.length > 0 ? (
                  present.map((s) => (
                    <div
                      key={s.userId}
                      className="text-[10px] text-gray-700 bg-white p-1 rounded-md font-medium"
                    >
                      {s.name}
                    </div>
                  ))
                ) : (
                  <p className="text-[10px] text-gray-500">None</p>
                )}
              </div>
            </div>

            <div className="flex-1 p-2 bg-red-50/70 rounded-lg">
              <h5 className="text-sm font-bold text-red-700 mb-1">
                ‚ùå Absent ({absent.length})
              </h5>
              <div className="max-h-24 overflow-y-auto space-y-1">
                {absent.length > 0 ? (
                  absent.map((s) => (
                    <div
                      key={s.userId}
                      className="text-[10px] text-gray-700 bg-white p-1 rounded-md font-medium"
                    >
                      {s.name}
                    </div>
                  ))
                ) : (
                  <p className="text-[10px] text-gray-500">None</p>
                )}
              </div>
            </div>
          </div>
        </div>
      );

    }

    


    ReactDOM.render(<AttendanceRegister />, document.getElementById('root'));
  </script>
</body>

</html>